<!DOCTYPE html>
<html>
<head>
  <title>Endpoint Evolution</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: -apple-system, system-ui, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #fff;
      color: #333;
    }
    h1 {
      margin: 0 0 10px 0;
      font-size: 24px;
      font-weight: 600;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .test-panel {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 30px;
      background: #f9f9f9;
    }
    .test-panel h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      font-weight: 600;
    }
    input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      font-family: monospace;
      font-size: 13px;
    }
    button {
      padding: 8px 16px;
      background: #000;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 13px;
      margin-top: 5px;
    }
    button:hover {
      background: #333;
    }
    .endpoint {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 15px;
    }
    .endpoint.dying {
      border-color: #dc3545;
      background: #fff5f5;
    }
    .path {
      font-family: monospace;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .health-bar {
      height: 20px;
      background: #f0f0f0;
      margin: 10px 0;
      border: 1px solid #ddd;
    }
    .health-fill {
      height: 100%;
      background: #28a745;
    }
    .health-fill.low { background: #ffc107; }
    .health-fill.critical { background: #dc3545; }
    .stats {
      display: flex;
      gap: 20px;
      margin: 10px 0;
      font-size: 13px;
      color: #666;
    }
    .code {
      background: #f5f5f5;
      padding: 10px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      border-left: 3px solid #ddd;
      max-height: 150px;
      overflow-y: auto;
    }
    .error {
      background: #fff5f5;
      color: #dc3545;
      padding: 8px;
      margin: 10px 0;
      font-size: 12px;
      border-left: 3px solid #dc3545;
    }
    .result {
      background: #f5f5f5;
      padding: 10px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>Endpoint Evolution</h1>
  <div class="subtitle">AI endpoints that spawn, evolve, and compete for survival</div>

  <div class="test-panel">
    <h3>Test Endpoint</h3>
    <input type="text" id="testPath" placeholder="Path (e.g., /hello, /reverse)" value="/hello">
    <input type="text" id="testInput" placeholder="Input (optional)" value="world">
    <button onclick="testEndpoint()">Execute</button>
    <div id="result"></div>
  </div>

  <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px;">
    <div id="endpoints"></div>
    <div>
      <h3 style="margin: 0 0 15px 0; font-size: 14px; font-weight: 600;">Live Feed</h3>
      <div id="drama" style="font-size: 12px; max-height: 600px; overflow-y: auto;"></div>
    </div>
  </div>

  <script>
    let openTimelines = new Set();

    async function testEndpoint() {
      const path = document.getElementById('testPath').value || '/test';
      const input = document.getElementById('testInput').value;
      const url = `${path}?input=${encodeURIComponent(input)}`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        document.getElementById('result').innerHTML = `<div class="result">${JSON.stringify(data, null, 2)}</div>`;
        setTimeout(refresh, 500);
      } catch (error) {
        document.getElementById('result').innerHTML = `<div class="error">${error.message}</div>`;
      }
    }

    function toggleTimeline(path) {
      if (openTimelines.has(path)) {
        openTimelines.delete(path);
      } else {
        openTimelines.add(path);
      }
    }

    async function refresh() {
      const [endpointsRes, dramaRes] = await Promise.all([
        fetch('/api/endpoints'),
        fetch('/api/drama')
      ]);

      const endpoints = await endpointsRes.json();
      const drama = await dramaRes.json();

      // Update drama feed
      const dramaHtml = drama.map(e => {
        const time = new Date(e.timestamp).toLocaleTimeString();
        const emoji = {
          spawn: 'üê£',
          death: 'üíÄ',
          evolution: 'üß¨',
          pr: 'üö®',
          beg: 'üò≠'
        }[e.type] || 'üì¢';

        return `<div style="padding: 8px; border-bottom: 1px solid #eee;">
          <div style="color: #999; font-size: 11px;">${time}</div>
          <div>${emoji} ${e.message}</div>
        </div>`;
      }).join('');

      document.getElementById('drama').innerHTML = dramaHtml || '<p style="color: #999;">No events yet</p>';

      if (endpoints.length === 0) {
        document.getElementById('endpoints').innerHTML = '<p style="color: #666;">No endpoints yet. Test one above to spawn.</p>';
        return;
      }

      const html = endpoints.map(e => {
        const healthClass = e.health < 30 ? 'critical' : e.health < 60 ? 'low' : '';
        const dying = e.health < 30 ? 'dying' : '';

        const timelineHtml = (e.timeline || []).map(event => {
          const time = new Date(event.timestamp).toLocaleTimeString();
          const typeEmoji = {
            spawn: 'üê£',
            success: '‚úÖ',
            failure: '‚ùå',
            evolution: 'üß¨',
            check: 'üîç'
          }[event.type] || 'üìù';

          const typeColor = {
            spawn: '#28a745',
            success: '#28a745',
            failure: '#dc3545',
            evolution: '#ffc107',
            check: '#999'
          }[event.type] || '#666';

          return `<div style="padding: 4px 0; font-size: 11px; border-left: 2px solid ${typeColor}; padding-left: 8px; margin: 2px 0;">
            <div style="color: #999;">${time}</div>
            <div>${typeEmoji} ${event.message}</div>
            <div style="color: #999;">Health: ${event.health}%</div>
          </div>`;
        }).join('');

        return `
          <div class="endpoint ${dying}">
            <div class="path">${e.path} ${e.isEvolving ? '(evolving...)' : ''}</div>
            <div class="health-bar">
              <div class="health-fill ${healthClass}" style="width: ${e.health}%"></div>
            </div>
            <div class="stats">
              <span>Health: ${e.health}%</span>
              <span>Uses: ${e.uses}</span>
              <span>Failures: ${e.failures}</span>
              <span>Desperation: ${e.desperation}</span>
              ${e.prNumber ? `<span>PR: #${e.prNumber}</span>` : ''}
            </div>
            ${e.lastError ? `<div class="error">${e.lastError}</div>` : ''}
            <div class="code">${e.code}</div>
            <details style="margin-top: 10px;" ${openTimelines.has(e.path) ? 'open' : ''} ontoggle="toggleTimeline('${e.path}')">
              <summary style="cursor: pointer; font-size: 12px; font-weight: 600;">Timeline (${(e.timeline || []).length} events)</summary>
              <div style="max-height: 200px; overflow-y: auto; margin-top: 5px; background: #fafafa; padding: 8px; border-radius: 3px;">
                ${timelineHtml || '<p style="color: #999; font-size: 11px;">No events yet</p>'}
              </div>
            </details>
          </div>
        `;
      }).join('');

      document.getElementById('endpoints').innerHTML = html;
    }

    refresh();
    setInterval(refresh, 2000);
  </script>
</body>
</html>
